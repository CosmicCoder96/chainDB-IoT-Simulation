<!DOCTYPE html>
<?php
//include 'config.php';
require 'function.php';
require 'head.php';
?>
<body class="hold-transition skin-blue layout-top-nav">
<!-- Site wrapper -->
<div class="wrapper">
    <!-- = Includo Header e Menu========================= -->
    <?php
    require 'header.php';
    //require 'sidebar.php'
    ?>
    <!-- =============================================== -->

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <h1>
                #SmartME
                <small>it all starts here</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
            </ol>
        </div>
        <!-- Main content -->
        <div class="content">
            <div class="row">
                <div class="col-md-4">
                    <!-- Profile Image -->
                    <div class="box box-primary">
                        <div class="box-body">
                            <div class="col-md-6">
                                <img src="img/SmartME_pothole.jpg" width="80%" alt="Logo #SmartME Pothole">
                                    <p class="text-muted text-center">Innovatively making the city of Messina "smart".</p>
                            </div>
                            <div class="col-md-6">
                                <h3 class="box-title">#SmartME Pothole</h3>

                                <p>The <b>#SmartME project</b> is a crowdfunded project born from a wish of a team of
                                    researchers in the Mobile and Distributed
                                    Systems Lab (MDSLab) at the University of Messina. Its aim is to encourage a
                                    conversation with the municipality of Messina
                                    in order to spur the creation of a novel virtual ecosystem based upon the paradigm of
                                    the <b>Internet of Things (IoT)</b>.</p>
                            </div>
                                <!-- /.box-body -->
                        </div>
                            <!-- /.box -->
                    </div>
                        <!-- /.box-body -->
                </div>
                <!-- /.box -->
                <div class="col-md-4">
                    <!-- Profile Image -->
                    <div class="box box-primary">
                        <div class="box-body">
                            <div class="col-md-6">
                                <img src="img/SmartME_parking.jpg" width="80%" alt="Logo #SmartME Parking">
                                <p class="text-muted text-center">Innovatively making the city of Messina "smart".</p>
                            </div>
                            <div class="col-md-6">
                                <h3 class="box-title">#SmartME Parking </h3>

                                <p>The <b>#SmartME project</b> is a crowdfunded project born from a wish of a team of
                                    researchers in the Mobile and Distributed
                                    Systems Lab (MDSLab) at the University of Messina. Its aim is to encourage a
                                    conversation with the municipality of Messina
                                    in order to spur the creation of a novel virtual ecosystem based upon the paradigm of
                                    the <b>Internet of Things (IoT)</b>.</p>
                            </div>
                            <!-- /.box-body -->
                        </div>
                        <!-- /.box -->
                    </div>
                    <!-- /.box-body -->
                </div>
                <!-- /.box -->
                <div class="col-md-4">
                    <!-- Profile Image -->
                    <div class="box box-primary">
                        <div class="box-body">
                            <div class="col-md-6">
                                <img src="img/SmartME_tour.jpg" width="80%" alt="Logo #SmartME Tour">
                                <p class="text-muted text-center">Innovatively making the city of Messina "smart".</p>
                            </div>
                            <div class="col-md-6">
                                <h3 class="box-title">#SmartME Tour</h3>

                                <p>The <b>#SmartME project</b> is a crowdfunded project born from a wish of a team of
                                    researchers in the Mobile and Distributed
                                    Systems Lab (MDSLab) at the University of Messina. Its aim is to encourage a
                                    conversation with the municipality of Messina
                                    in order to spur the creation of a novel virtual ecosystem based upon the paradigm of
                                    the <b>Internet of Things (IoT)</b>.</p>
                            </div>
                            <!-- /.box-body -->
                        </div>
                        <!-- /.box -->
                    </div>
                    <!-- /.box-body -->
                </div>
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-md-4">
                    <!-- Profile Image -->
                    <div class="box box-primary">
                        <div class="box-body">
                            <div class="col-md-6">
                                <img src="img/SmartME_lighting.jpg" width="80%" alt="Logo #SmartME Lighting">
                                <p class="text-muted text-center">Innovatively making the city of Messina "smart".</p>
                            </div>
                            <div class="col-md-6">
                                <h3 class="box-title">#SmartME Lighting </h3>

                                <p>The <b>#SmartME project</b> is a crowdfunded project born from a wish of a team of
                                    researchers in the Mobile and Distributed
                                    Systems Lab (MDSLab) at the University of Messina. Its aim is to encourage a
                                    conversation with the municipality of Messina
                                    in order to spur the creation of a novel virtual ecosystem based upon the paradigm of
                                    the <b>Internet of Things (IoT)</b>.</p>
                            </div>
                            <!-- /.box-body -->
                        </div>
                        <!-- /.box -->
                    </div>
                    <!-- /.box-body -->
                </div>
                <!-- /.box -->
                <div class="col-md-4">
                    <!-- Profile Image -->
                    <div class="box box-primary">
                        <div class="box-body">
                            <div class="col-md-6">
                                <img src="img/SmartME_taxi.jpg" width="80%" alt="Logo #SmartME Taxi">
                                <p class="text-muted text-center">Innovatively making the city of Messina "smart".</p>
                            </div>
                            <div class="col-md-6">
                                <h3 class="box-title">#SmartME Taxi</h3>

                                <p>The <b>#SmartME project</b> is a crowdfunded project born from a wish of a team of
                                    researchers in the Mobile and Distributed
                                    Systems Lab (MDSLab) at the University of Messina. Its aim is to encourage a
                                    conversation with the municipality of Messina
                                    in order to spur the creation of a novel virtual ecosystem based upon the paradigm of
                                    the <b>Internet of Things (IoT)</b>.</p>
                            </div>
                            <!-- /.box-body -->
                        </div>
                        <!-- /.box -->
                    </div>
                    <!-- /.box-body -->
                </div>
                <!-- /.box -->
                <div class="col-md-4">
                    <!-- Profile Image -->
                    <div class="box box-primary">
                        <div class="box-body">
                            <div class="col-md-6">
                                <img src="img/SmartME_energy.jpg" width="80%" alt="Logo #SmartME Energy">
                                <p class="text-muted text-center">Innovatively making the city of Messina "smart".</p>
                            </div>
                            <div class="col-md-6">
                                <h3 class="box-title">#SmartME Energy </h3>

                                <p>The <b>#SmartME project</b> is a crowdfunded project born from a wish of a team of
                                    researchers in the Mobile and Distributed
                                    Systems Lab (MDSLab) at the University of Messina. Its aim is to encourage a
                                    conversation with the municipality of Messina
                                    in order to spur the creation of a novel virtual ecosystem based upon the paradigm of
                                    the <b>Internet of Things (IoT)</b>.</p>
                            </div>
                            <!-- /.box-body -->
                        </div>
                        <!-- /.box -->
                    </div>
                    <!-- /.box-body -->
                </div>
            </div>
            <!-- /.row -->

            <!-- /.row -->
        </div>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
     </div>
    <?php include 'footer.php' ?>
</div>
<!-- ./wrapper -->

<script type="text/javascript" src="assets/dist/js/jquery-2.2.1.min.js"></script>

<!--
    <script type="text/javascript" src="assets/dist/js/d3.min.js"></script>
    <script type="text/javascript" src="assets/dist/js/crossfilter.min.js"></script>
    <script type="text/javascript" src="assets/dist/js/dc.min.js"></script>

!-->

<!-- Bootstrap 3.3.5 -->
<script src="assets/bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript" src="assets/dist/js/leaflet.js"></script>
<script type="text/javascript" src="assets/dist/js/ll_MarkerCluster.js"></script>


<!-- DataTables -->
<script src="assets/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="assets/plugins/datatables/dataTables.bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="assets/plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="assets/plugins/fastclick/fastclick.min.js"></script>

<!-- AdminLTE App -->
<script src="assets/dist/js/app.min.js"></script>
<script src="assets/highstock.js"></script>
<script src="assets/jsonpath.js"></script>

<div class="modal fade" id="sensor_modal"  tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
        <div class="modal-header">
            <a href="#" class="pull-right" data-dismiss="modal" aria-label="Close">
                <span class="fa fa-close"></span>
            </a>
            <h3 class="modal-title">
                <p>
                    <span id="sensor_name"></span> in <span id="measure_unit"></span>
                </p>
                <div class="pull-right">
                    <a id="download_csv" href="http://smartme-data.unime.it/datastore/dump/{{$resource_id}}"
                       class="btn btn-warning btn-sm"><span class="fa fa-download"></span> Download CSV
                    </a>
                    <a id="open_data_link" target="_blank" href="http://smartme-data.unime.it/dataset/{{$pack_name}}/resource/{{resource_id}}"
                       class="btn btn-primary btn-sm"><span class="fa fa-external-link"></span> Open Data
                    </a>
                </div>
            </h3>
            <p class="small">Viewing <?=$res_limit[$limit]?></p>
            <div class="form-group form-inline">
                <label>Data view:</label>
                <select class="form-control" id="modal_last_result">
                    <?php
                    foreach ($res_limit as $k => $v) {
                        $t = ($k == $limit) ? "selected " : "";
                        echo '<option value="' . $k . '" ' . $t . ">" . $v . "</option>\n";
                    }
                    ?>
                </select>
            </div>
        </div>
        <!-- Main content -->
        <div class="modal-body">
            <div class="row">
                <div id="chart" class="col-xs-12 col-md-12">
                    <div id="hicharts" class="col-xs-12 col-md-12"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
    </div>
     </div>
</div>

<div class="modal fade" id="info_modal"  tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        // Gestione LocalStorage
        function PackSave(pack) {
            localStorage.setItem("package", JSON.stringify(pack));
        }
        function PackLoad(pack_id) {
            var pack_item = JSON.parse(localStorage.getItem("package"));
            var pack = [];

            for (var i = 0; i < pack_item.length; i++) {
                if (pack_item[i]) {
                    if (pack_item[i].id == pack_id) {
                        pack = pack_item[i];
                    }
                }
            }
            return pack;
        }

        // Funzioni di supporto
        // inserimento dei mark dall'elenco delle BOARDS.
        function GetSensoriConDati() {
            var jcall = JsonpCall(package_url, "", 1000, "GetCKAN");
            var res = [];
            var extras = [];

            var board_spente = ["",  "sme-00-0006 - Policlinico Universitario", "sme-01-0008", "sme-00-0016 - Villa Pace"];

            jcall.done(function (data) {
                $.each(data.result, function (k, v) {
                    extras = v.extras;
                    var lat;
                    var long;
                    if (v.num_resources > 0 && v.organization.title == ckan_organization && (board_spente.indexOf(v.notes) < 0)) {
                        packages[k] = {
                            id: v.id,
                            lat: "",
                            long: "",
                            label: "",
                            name: v.name,
                            resources: [],
                            sensori: ""
                        };

                        $.each(v.resources, function (kk, vv) {
                            if (vv.name) {
                                packages[k]['resources'].push({name: vv.name, id: vv.id})
                            }
                        });

                        if (extras.length) {
                            for (var i = 0; i < extras.length; i++) {
                                var record = extras[i];
                                switch (record.key) {
                                    case "Label":
                                        packages[k]['label'] = record.value;
                                        break;
                                    case "Latitude":
                                        packages[k]['lat'] = record.value;
                                        break;
                                    case "Longitude":
                                        packages[k]['long'] = record.value;
                                        break;
                                }
                            }
                        }
                    }
                });
            }).then(function () {
                for (var i = 0; i < packages.length; i++) {
                    var pack = packages[i];
                    try {
                        if (pack.lat) {
                            var lat = pack.lat;
                            var long = pack.long;
                            var elenco_sensori = "";
                            var board = "";
                            var sensori = pack.resources;
                            for (var j = 0; j < sensori.length; j++) {
                                if (sensori[j].name != "sensors") {
                                    var sensor_url = (sensori[j].name == "gas") ? "" : 'pack_name=' + pack.name + '&id=' + sensori[j].id + '&limit=<?=$limit?>&sensor=' + sensori[j].name;
                                    var padding = (sensori[j].name == "gas") ? " Coming Soon" : "";

                                    elenco_sensori += '<a class="list-group-item call_modal ' + icons[sensori[j].name].color +
                                        ' bold" style="color:white" sensor-name="' + sensori[j].name +
                                        '" id="' + sensori[j].id + '" pack_name="' + pack.name +
                                        '" url="' + sensor_url + '" href="#sensor_modal">' +
                                        '<i class="' + icons[sensori[j].name].icon + '"></i> '
                                        + sensori[j].name + ' <span class="label text-maroon" style="background-color: white">'
                                        + padding + "</span></a>\n";
                                } else {
                                    board = '&nbsp;<a class="btn btn-primary btn-sm pull-right" data-toggle="modal" data-target="#info_modal" href="details.php?pack_name=' + pack.name + '&pack_id=' + pack.id + '&res_id=' + sensori[j].id + '">' +
                                        '<i style="color: white" class="fa fa-info-circle"></i></a>' + "<br><br>\n";
                                }
                            }
                            if (lat) {
                                var yun = L.icon({
                                    iconUrl: "img/sensor.png",
                                    iconSize: [32,32]
                                });

                                var marker = L.marker([lat, long], {title: pack.label, icon: yun });
                                var popup = L.popup({maxWidth: 500, minWidth: 180})
                                    .setContent('<div class="punto" id="' + pack.id + '" pack="' + pack.id + '" ><b>' + pack.label + '</b>' + board + '<br>\n<span class="sample_date text-light-blue">&nbsp;</span>' +
                                    '<div class="list-group text-left">' + elenco_sensori + '</div></div>');

                                marker.bindPopup(popup);
                                sensors.addLayer(marker);
                                map.addLayer(sensors);
                            }

                        }
                    } catch (err) {
                        console.log(".");
                    }

                }
            });
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function JsonpCall(url, val, limit, func) {
            var data_call = $.ajax({
                url: url,
                dataType: 'jsonp',
                async: false,
                cache: true, // necessario per interrogare ckan
                data: {"resource_id": val, "limit": limit},
                jsonpCallback: func
            });
            return data_call;
        }

        function GetSensorList(data) {
            $.each(data.result.records, function (k, v) {
                if (v.name != "_table_metadata") {
                    sensori[k] = v;
                }
            });
        }

        function GetCKAN(data) {
            return data;
        }

        function PotHolesLoad() {
            $.ajax({
                url: './jsonp_call.php?holes=true',
                dataType: 'json',
                success: function (data) {
                    HolesLoaded(data);
                },
                error: function (e) {
                    console.log(e);
                }
            });

        }
        function HolesLoaded(d) {
            // console.log(data);
            for (var i = 0; i < d.length; i++) {
                var pack = d[i];
                try {
                    var lat = pack.lat;
                    var long = pack.lon;
                    var bump = L.icon({
                        iconUrl: "img/icon_pothole.png",
                        iconSize: [32,32]
                    });
                    var marker = L.marker([lat, long], {title: pack.address, icon: bump});
                    var popup = L.popup({maxWidth: 500, minWidth: 180})
                        .setContent('<div class="punto " id="' + pack.id + '" pack="' + pack.id + '" > ' +
                        '<h4> <b>'+ pack.num + '</b> Reports.</h4>' +
                        '<h4>' + pack.address + '</h4>' +
                        '<h4>Mean Acceleration from <b>' + Math.round10(pack.minMeanAcc ,-2)+ '</b>' +
                        ' to <b>' + Math.round10(pack.maxMeanAcc,-2)+ '</b>' +
                        '</h4></div>');
                    marker.bindPopup(popup);
                    potholes.addLayer(marker);
                    map.addLayer(potholes);
                } catch (err) {
                    console.log(err);
                }

            }
        }

        // variabili globali

        var roads = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> - by <b>Ciam</b>'
        });

        var map = L.map('mapdiv', {
            center: [38.20523, 15.55972],
            zoom: 11,
            layers: roads
        });

        var sensors = L.markerClusterGroup({});

        var potholes = L.markerClusterGroup({});

        //console.log(L);

        var packages = [];
        var sensori = [];
        var ckan_organization = "SmartMe";
        var limit = <?=$limit?>;
        var icons = {
            'noise': {
                color: "bg-navy", icon: "fa fa-volume-up"
            }
            ,

            temperature: {
                color: "bg-orange", icon: "fa fa-sun-o"
            }
            ,
            brightness: {
                color: "bg-green", icon: "fa fa-lightbulb-o"
            }
            ,
            humidity: {
                color: "bg-aqua", icon: "fa fa-tint"
            }
            ,
            pressure: {
                color: "bg-purple", icon: "fa fa-dot-circle-o"
            }
            ,
            gas: {
                color: "bg-maroon", icon: "fa fa-industry"
            }
        };



        var overlayMaps = {
            "SmartME Potholes": potholes,
            "SmartME Sensors" : sensors
        };

        L.control.layers("",overlayMaps).addTo(map);
        // elenco dei packages si trova alla seguente URL:
        var package_url = "http://smartme-data.unime.it/api/3/action/current_package_list_with_resources";

        // esecuzione prima chiamata per la generazione dell'elenco dei sensori
        GetSensoriConDati();
        PotHolesLoad();

        map.on('popupopen', function (e) {
            var el = $('<div></div>');
            var link = [];
            el.html(e.target._popup._content);
            var pack_id = el[0].getElementsByClassName('punto')[0].getAttribute("pack");
            var AllData = $.getJSON('jsonp_call.php?pack_name=' + pack_id);
            AllData.done(function (data) {
                // imposto data ultimo sample
                //el[0].getElementsByClassName('sample_date')[0].innerHTML = data[0].date;

                //console.log(el[0].getElementsByClassName('sample_date')[0]);

                var all_sens = $('a', el).filter(function (k, val) {
                    var sensor_id = val.toString().split("=")[0];

                   // console.log(sensor_id);

                    if (sensor_id) {
                        var text = capitalizeFirstLetter(val.text.trim());
                        var result = JSONPath("$..*[?(@.name==='" + text + "')]", AllData);

                        if (result.length) {
                            var t = result[0].value;
                            var d = result[0].date;
                            var id_element = val.getAttribute('id');
                            if (val.getAttribute('id') == result[0].id) {
                                var tt = $("#" + id_element).html();
                                $("#" + id_element).html(tt + ' <span class="text-center text-bold pull-right">' + t + '</span>');
                            }
                            $(".sample_date").html("Last Sample: <b>" + data[0].date + "</b>");
                        }
                    }
                });
            });
        });

        $("#last_result").change(function () {
            window.location = "<?=$_SERVER['PHP_SELF']?>?limit=" + $(this).val();
        });

        $(".modal").on('hidden.bs.modal',  function (e) {
            $(this).data('bs.modal', null);
            $(this).removeData('bs.modal');
        });

        // funzioni per il local storage
        localStorage.setItem("package", "");

        function DrawGraph(url){
            var dati_sensore = $.getJSON(url,
                function(data) {
                    $.each(data, function (k, v) {
                        var d = new Date(v.date);
                        v.x = Date.parse(d);
                        v.y = parseFloat(v.value);
                    });
                    return data;
                });

            dati_sensore.done(function (data){
                var chart_width = parseInt($('.modal-lg').width() -50 );
                var Chart = new Highcharts.StockChart({
                    chart: {
                        type: 'line',
                        renderTo: "hicharts",
                        height: '320',
                        width: chart_width, // (chart_width>760)?chart_width:560,
                        events: {
                            redraw: function () {
                               // addNoise(Chart, sensor_name);
                            }
                        }
                    },
                    title: {
                        text: sensor_name
                    },
                    rangeSelector: {
                        buttons: [{
                            type: 'hour',
                            count: 1,
                            text: '1h'
                        }, {
                            type: 'hour',
                            count: 3,
                            text: '3h'
                        }, {
                            type: 'day',
                            count: 1,
                            text: '1d'
                        }, {
                            type: 'day',
                            count: 3,
                            text: '3d'
                        },{
                            type: 'all',
                            text: 'All'
                        }],
                        inputEnabled: true, // it supports only days
                        selected: 4 // all
                    },
                    xAxis: {
                        dateTimeLabelFormats: {
                            hour: "%b %e, %H:%M",
                            month: '%e. %b',
                            year: '%b'
                        },
                        type: 'datetime'
                    },
                    yAxis: {
                        title: {
                            text: 'unit:' + unit[sensor_name]
                        }
                    },
                    tooltip: {
                        valueDecimals: 1,
                        valueSuffix: " " + unit[sensor_name]
                    },
                    series: [{
                        name: sensor_name,
                        data: data
                    }]

                });
            });

        }

        $(document).on('click' , '.call_modal', function(e)
        {
            e.preventDefault();
             id_sensor = $(this).attr('id');
             sensor_name =  $(this).attr('sensor-name');
             post_data = $(this).attr('url');
             pack_name = $(this).attr('pack_name');
             unit  = <?=json_encode($unit)?>;

            $("#sensor_name").html(capitalizeFirstLetter(sensor_name));
            $("#measure_unit").html(unit[sensor_name]);
            $('#download_csv').attr('href', 'http://smartme-data.unime.it/datastore/dump/' + id_sensor);
            $('#open_data_link').attr('href', 'http://smartme-data.unime.it/dataset/' + pack_name + '/resource/' + id_sensor);


            url = 'jsonp_call.php?id=' + id_sensor+ '&limit=<?= $limit ?>&sensor=' + sensor_name;

            DrawGraph(url);

            $("#sensor_modal").modal('show');

        });

        function addNoise (Chart, sensor_name){
            // CASE NOISE add plot bands
            if (sensor_name == "noise") {
                Chart.yAxis.addPlotbands(
                    {
                        from: 8.25,
                        to: 43,
                        color: 'rgba(68, 170, 213, 0.1)',
                        label: {
                            text: 'Talk Loudly',
                            style: {
                                color: '#606060'
                            }
                        }
                    }, {
                        from: 43,
                        to: 115,
                        color: 'rgba(0, 0, 0, 0)',
                        label: {
                            text: 'Phone Ring, Loud radio/tv',
                            style: {
                                color: '#FFFFFF'
                            }
                        }
                    }, {
                        from: 115,
                        to: 394,
                        color: 'rgba(68, 170, 213, 0.1)',
                        label: {
                            text: 'Alarm Ringtone, Party, Traffic',
                            style: {
                                color: '#606060'
                            }
                        }
                    }, {
                        from: 394,
                        to: 1000,
                        color: 'rgba(0, 0, 0, 0)',
                        label: {
                            text: 'Rush Hour Traffic',
                            style: {
                                color: '#606060'
                            }
                        }
                    })
                    .series[0].update({
                        useHTML: true,
                        formatter: function () {
                            var s = '<span class="small">' + Highcharts.dateFormat("%A, %b %e,  %H:%M", this.x) + '</span>';
                            $.each(this.points, function () {
                                var yy = this.y;
                                var label;
                                switch (true) {
                                    case (yy < 2.75):
                                        label = "rustle";
                                        break;
                                    case (yy >= 2.75 && yy < 4):
                                        label = "library";
                                        break;
                                    case (yy >= 4 && yy < 8.25):
                                        label = "domestic enviroment";
                                        break;
                                    case (yy >= 8.25 && yy < 43):
                                        label = "talk loudly";
                                        break;
                                    case (yy >= 43 && yy < 115):
                                        label = "phone ring, loud radio/tv";
                                        break;
                                    case (yy >= 115 && yy < 394):
                                        label = "ringtone, party, road";
                                        break;
                                    case (yy >= 394):
                                        label = "rush hour traffic";
                                        break;
                                }

                                s += '<br/>' + this.series.name +
                                    ': <b>' +
                                    this.y + '</b> Amplitude ' +
                                    '<b class="text-center">' + label + '</b>';
                            });
                            return s;
                        },
                        shared: true
                    });
            }
        }

        $("#modal_last_result").change(function () {
            var limit = $(this).val();
            var url = 'jsonp_call.php?id=' + id_sensor+ '&limit=' + limit + '&sensor=' + sensor_name;
            DrawGraph(url);
        });


    });




    function decimalAdjust(type, value, exp) {
        // If the exp is undefined or zero...
        if (typeof exp === 'undefined' || +exp === 0) {
            return Math[type](value);
        }
        value = +value;
        exp = +exp;
        // If the value is not a number or the exp is not an integer...
        if (isNaN(value) || !(typeof exp === 'number' && exp % 1 === 0)) {
            return NaN;
        }
        // Shift
        value = value.toString().split('e');
        value = Math[type](+(value[0] + 'e' + (value[1] ? (+value[1] - exp) : -exp)));
        // Shift back
        value = value.toString().split('e');
        return +(value[0] + 'e' + (value[1] ? (+value[1] + exp) : exp));
    }

    // Decimal round
    if (!Math.round10) {
        Math.round10 = function (value, exp) {
            return decimalAdjust('round', value, exp);
        };
    }
    // Decimal floor
    if (!Math.floor10) {
        Math.floor10 = function (value, exp) {
            return decimalAdjust('floor', value, exp);
        };
    }
    // Decimal ceil
    if (!Math.ceil10) {
        Math.ceil10 = function (value, exp) {
            return decimalAdjust('ceil', value, exp);
        };
    }

</script>


</body>
</html>
